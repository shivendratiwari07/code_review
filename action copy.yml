name: "Automated Code Review with Philips OpenAI API"
description: "Run an automated code review on pull requests using Philips OpenAI API and post comments to PR."

inputs:
  GITHUB_TOKEN:
    description: "GitHub token to authenticate the API requests"
    required: true
  GITHUB_REPOSITORY:
    description: "GitHub repository name (e.g., owner/repo)"
    required: true
  PR_NUMBER:
    description: "Pull request number"
    required: true
  DEX_USERNAME:
    description: "Dex Username"
    required: true
  DEX_PASSWORD:
    description: "Dex Password"
    required: true

runs:
  using: "composite"
  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libnss3 \
          libxss1 \
          libasound2 \
          libatk1.0-0 \
          libpangocairo-1.0-0 \
          libgtk-3-0 \
          fonts-liberation \
          libgbm-dev

    - name: Check Microsoft Edge and WebDriver versions
      shell: bash
      run: |
        microsoft-edge --version || echo "Edge not found"
        msedgedriver --version || echo "Edge WebDriver not found"

    - name: Set up Python environment
      shell: bash
      run: |
        pip install selenium requests webdriver-manager pyotp

    - name: Run get_cookies_selenium.py
      id: get_cookies
      shell: bash
      env:
        DEX_USERNAME: ${{ inputs.DEX_USERNAME }}
        DEX_PASSWORD: ${{ inputs.DEX_PASSWORD }}
      run: |
        CUSTOM_SERVICE_COOKIE=$(python ${{ github.action_path }}/script/get_cookies_selenium.py)
        echo "::set-output name=CUSTOM_SERVICE_COOKIE::${CUSTOM_SERVICE_COOKIE}"

    - name: Run the code review script
      if: steps.get_cookies.conclusion == 'success'
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
        CUSTOM_SERVICE_COOKIE: ${{ steps.get_cookies.outputs.CUSTOM_SERVICE_COOKIE }}
        GITHUB_REPOSITORY: ${{ inputs.GITHUB_REPOSITORY }}
        PR_NUMBER: ${{ inputs.PR_NUMBER }}
        GITHUB_SHA: ${{ github.event.pull_request.head.sha }}
      run: |
        python ${{ github.action_path }}/script/code_review.py